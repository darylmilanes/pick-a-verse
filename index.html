<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scripture Pick + Gemini</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (to compile JSX in browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Markdown Parser for AI responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@400;500;600&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        .font-serif {
            font-family: 'Playfair Display', serif;
        }
        
        .cursor-wait {
            cursor: wait;
        }

        /* Markdown Styles */
        .prose p { margin-bottom: 0.5em; }
        .prose strong { font-weight: 600; color: #475569; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // --- GEMINI API CONFIGURATION ---
        const callGemini = async (prompt, userKey) => {
            // Priority: User's Key -> System Key (if injected) -> Empty
            let apiKey = userKey || ""; 
            
            if (!apiKey) {
                throw new Error("Missing API Key. Please add one in Settings.");
            }

            const model = "gemini-2.5-flash-preview-09-2025";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };

            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
            // Backoff: 1s, 2s, 4s, 8s
            const delays = [1000, 2000, 4000, 8000];

            for (let i = 0; i < 4; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errData = await response.json().catch(() => ({}));
                        // If key is invalid (400/403), don't retry, fail immediately
                        if (response.status === 400 || response.status === 403) {
                            throw new Error("Invalid API Key. Please check Settings.");
                        }
                        if (response.status === 429) {
                            await delay(delays[i]);
                            continue;
                        }
                        throw new Error(`Server Error (${response.status})`);
                    }

                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response generated.";
                } catch (error) {
                    if (i === 3 || error.message.includes("Invalid API Key") || error.message.includes("Missing API Key")) {
                        throw error;
                    }
                    await delay(delays[i]);
                }
            }
        };

        // --- ICONS ---
        const IconBook = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>;
        const IconRefreshCw = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>;
        const IconSparkles = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 9h4"/></svg>;
        const IconX = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>;
        const IconMessage = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>;
        const IconHeartHandshake = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>;
        const IconSettings = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>;
        const IconSave = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;

        // --- DATA ---
        const BIBLE_DATA = [
            // --- OLD TESTAMENT ---
            { name: "Genesis", v: [31,25,24,26,32,22,24,22,29,32,32,20,18,24,21,16,27,33,38,18,34,24,20,67,34,35,46,22,35,43,55,32,20,31,29,43,36,30,23,23,57,38,34,34,28,34,31,22,33,26] },
            { name: "Exodus", v: [22,25,22,31,23,30,25,32,35,29,10,51,22,31,27,36,16,27,25,26,36,31,33,18,40,37,21,43,46,38,18,35,23,35,35,38,29,31,43,38] },
            { name: "Leviticus", v: [17,16,17,35,19,30,38,36,24,20,47,8,59,57,33,34,16,30,37,27,24,33,44,23,55,46,34] },
            { name: "Numbers", v: [54,34,51,49,31,27,89,26,23,36,35,16,33,45,41,50,13,32,22,29,35,41,30,25,18,65,23,31,40,16,54,42,56,29,34,13] },
            { name: "Deuteronomy", v: [46,37,29,49,33,25,26,20,29,22,32,32,18,29,23,22,20,22,21,20,23,30,25,22,19,19,26,68,29,20,30,52,29,12] },
            { name: "Joshua", v: [18,24,17,24,15,27,26,35,27,43,23,24,33,15,63,10,18,28,51,9,45,34,16,33] },
            { name: "Judges", v: [36,23,31,24,31,40,25,35,57,18,40,15,25,20,20,31,13,31,30,48,25] },
            { name: "Ruth", v: [22,23,18,22] },
            { name: "1 Samuel", v: [28,36,21,22,12,21,17,22,27,27,15,25,23,52,35,23,58,30,24,42,15,23,29,22,44,25,12,25,11,31,13] },
            { name: "2 Samuel", v: [27,32,39,12,25,23,29,18,13,19,27,31,39,33,37,23,29,33,43,26,22,51,39,25] },
            { name: "1 Kings", v: [53,46,28,34,18,38,51,66,28,29,43,33,34,31,34,34,24,46,21,43,29,53] },
            { name: "2 Kings", v: [18,25,27,44,27,33,20,29,37,36,21,21,25,29,38,20,41,37,37,21,26,20,37,20,30] },
            { name: "1 Chronicles", v: [54,55,24,43,26,81,40,40,44,14,47,40,14,17,29,43,27,17,19,8,30,19,32,31,31,32,34,21,30] },
            { name: "2 Chronicles", v: [17,18,17,22,14,42,22,18,31,19,23,16,22,15,19,14,19,34,11,37,20,12,21,27,28,23,9,27,36,27,21,33,25,33,27,23] },
            { name: "Ezra", v: [11,70,13,24,17,22,28,36,15,44] },
            { name: "Nehemiah", v: [11,20,32,23,19,19,73,18,38,39,36,47,31] },
            { name: "Esther", v: [22,23,15,17,14,14,10,17,32,3] },
            { name: "Job", v: [22,13,26,21,27,30,21,22,35,22,20,25,28,22,35,22,16,21,29,29,34,30,17,25,6,14,23,28,25,31,40,22,33,37,16,33,24,41,30,24,34,17] },
            { name: "Psalms", v: [6,12,8,8,12,10,17,9,20,18,7,8,6,7,5,11,15,50,14,9,13,31,6,10,22,12,14,9,11,12,24,11,22,22,28,12,40,22,13,17,13,11,5,26,17,11,9,14,20,23,19,9,6,7,23,13,11,11,17,12,8,12,11,10,13,20,7,35,36,5,24,20,28,23,10,12,20,72,13,19,16,8,18,12,13,17,7,18,52,17,16,15,5,23,11,13,12,9,9,5,8,28,22,35,45,48,43,13,31,7,10,10,9,8,18,19,2,29,176,7,8,9,4,8,5,6,5,6,8,8,3,18,3,3,21,26,9,8,24,13,10,7,12,15,21,10,20,14,9,6] },
            { name: "Proverbs", v: [33,22,35,27,23,35,27,36,18,32,31,28,25,35,33,33,28,24,29,30,31,29,35,34,28,28,27,28,27,33,31] },
            { name: "Ecclesiastes", v: [18,26,22,16,20,12,29,17,18,20,10,14] },
            { name: "Song of Solomon", v: [17,17,11,16,16,13,13,14] },
            { name: "Isaiah", v: [31,22,26,6,30,13,25,22,21,34,16,6,22,32,9,14,14,7,25,6,17,25,18,23,12,21,13,29,24,33,9,20,24,17,10,22,38,22,8,31,29,25,28,28,25,13,15,22,26,11,23,15,12,17,13,12,21,14,21,22,11,12,19,12,25,24] },
            { name: "Jeremiah", v: [19,37,25,31,31,30,34,22,26,25,23,17,27,22,21,21,27,23,15,18,14,30,40,10,38,24,22,17,32,24,40,44,26,22,19,32,21,28,18,16,18,22,13,30,5,28,7,47,39,46,64,34] },
            { name: "Lamentations", v: [22,22,66,22,22] },
            { name: "Ezekiel", v: [28,10,27,17,17,14,27,18,11,22,25,28,23,23,8,63,24,32,14,49,32,31,49,27,17,21,36,26,21,26,18,32,33,31,15,38,28,23,29,49,26,20,27,31,25,24,23,35] },
            { name: "Daniel", v: [21,49,30,37,31,28,28,27,27,21,45,13] },
            { name: "Hosea", v: [11,23,5,19,15,11,16,14,17,15,12,14,16,9] },
            { name: "Joel", v: [20,32,21] },
            { name: "Amos", v: [15,16,15,13,27,14,17,14,15] },
            { name: "Obadiah", v: [21] },
            { name: "Jonah", v: [17,10,10,11] },
            { name: "Micah", v: [16,13,12,13,15,16,20] },
            { name: "Nahum", v: [15,13,19] },
            { name: "Habakkuk", v: [17,20,19] },
            { name: "Zephaniah", v: [18,15,20] },
            { name: "Haggai", v: [15,23] },
            { name: "Zechariah", v: [21,13,10,14,11,15,14,23,17,12,17,14,9,21] },
            { name: "Malachi", v: [14,17,18,6] },

            // --- NEW TESTAMENT ---
            { name: "Matthew", v: [25,23,17,25,48,34,29,34,38,42,30,50,58,36,39,28,27,35,30,34,46,46,39,51,46,75,66,20] },
            { name: "Mark", v: [45,28,35,41,43,56,37,38,50,52,33,44,37,72,47,20] },
            { name: "Luke", v: [80,52,38,44,39,49,50,56,62,42,54,59,35,35,32,31,37,43,48,47,38,71,56,53] },
            { name: "John", v: [51,25,36,54,47,71,53,59,41,42,57,50,38,31,27,33,26,40,42,31,25] },
            { name: "Acts", v: [26,47,26,37,42,15,60,40,43,48,30,25,52,28,41,40,34,28,41,38,40,30,35,27,27,32,44,31] },
            { name: "Romans", v: [32,29,31,25,21,23,25,39,33,21,36,21,14,23,33,27] },
            { name: "1 Corinthians", v: [31,16,23,21,13,20,40,13,27,33,34,31,13,40,58,24] },
            { name: "2 Corinthians", v: [24,17,18,18,21,18,16,24,15,18,33,21,14] },
            { name: "Galatians", v: [24,21,29,31,26,18] },
            { name: "Ephesians", v: [23,22,21,32,33,24] },
            { name: "Philippians", v: [30,30,21,23] },
            { name: "Colossians", v: [29,23,25,18] },
            { name: "1 Thessalonians", v: [10,20,13,18,28] },
            { name: "2 Thessalonians", v: [12,17,18] },
            { name: "1 Timothy", v: [20,15,16,16,25,21] },
            { name: "2 Timothy", v: [18,26,17,22] },
            { name: "Titus", v: [16,15,15] },
            { name: "Philemon", v: [25] },
            { name: "Hebrews", v: [14,18,19,16,14,20,28,13,28,39,40,29,25] },
            { name: "James", v: [27,26,18,17,20] },
            { name: "1 Peter", v: [25,25,22,19,14] },
            { name: "2 Peter", v: [21,22,18] },
            { name: "1 John", v: [10,29,24,21,21] },
            { name: "2 John", v: [13] },
            { name: "3 John", v: [14] },
            { name: "Jude", v: [25] },
            { name: "Revelation", v: [20,29,22,11,14,17,17,13,21,11,19,17,18,20,8,21,18,24,21,15,27,21] }
        ];

        function BiblePicker() {
          const [currentSelection, setCurrentSelection] = useState(null);
          const [isAnimating, setIsAnimating] = useState(false);
          const [history, setHistory] = useState([]);
          const [showHistory, setShowHistory] = useState(false);
          const [showSettings, setShowSettings] = useState(false);

          // API Key State
          const [apiKey, setApiKey] = useState(() => localStorage.getItem('gemini_api_key') || '');
          const [tempApiKey, setTempApiKey] = useState('');

          // AI States
          const [aiContent, setAiContent] = useState(null); 
          const [aiLoading, setAiLoading] = useState(false);
          const [aiError, setAiError] = useState(null);

          const aiSectionRef = useRef(null);

          const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

          const handleSaveKey = () => {
              localStorage.setItem('gemini_api_key', tempApiKey);
              setApiKey(tempApiKey);
              setShowSettings(false);
              setAiError(null); // Clear previous errors
          };

          const openSettings = () => {
              setTempApiKey(apiKey);
              setShowSettings(true);
              setShowHistory(false);
          };

          const generateVerse = useCallback(() => {
            if (isAnimating) return;
            
            setIsAnimating(true);
            setShowHistory(false);
            setAiContent(null);
            setAiError(null);

            let duration = 2000; 
            let startTime = Date.now();
            let intervalId;

            const animate = () => {
              const now = Date.now();
              const elapsed = now - startTime;
              
              if (elapsed < duration) {
                const randomBook = BIBLE_DATA[Math.floor(Math.random() * BIBLE_DATA.length)];
                const randomChapterIndex = Math.floor(Math.random() * randomBook.v.length);
                const maxVerse = randomBook.v[randomChapterIndex];
                
                setCurrentSelection({
                  book: randomBook.name,
                  chapter: randomChapterIndex + 1,
                  verse: getRandomInt(1, maxVerse),
                  maxVerse: maxVerse
                });
              } else {
                clearInterval(intervalId);
                
                const finalBook = BIBLE_DATA[Math.floor(Math.random() * BIBLE_DATA.length)];
                const finalChapterIndex = Math.floor(Math.random() * finalBook.v.length);
                const finalMaxVerse = finalBook.v[finalChapterIndex];
                const finalVerse = getRandomInt(1, finalMaxVerse);
                
                const finalResult = {
                  book: finalBook.name,
                  chapter: finalChapterIndex + 1,
                  verse: finalVerse,
                  maxVerse: finalMaxVerse,
                  timestamp: new Date()
                };

                setCurrentSelection(finalResult);
                setHistory(prev => [finalResult, ...prev].slice(0, 50));
                setIsAnimating(false);
              }
            };

            intervalId = setInterval(animate, 60);
          }, [isAnimating]);

          const handleAiAction = async (type) => {
              if (!currentSelection) return;
              
              setAiLoading(true);
              setAiError(null);
              setAiContent({ type, text: '' }); 

              setTimeout(() => {
                 aiSectionRef.current?.scrollIntoView({ behavior: 'smooth' });
              }, 100);

              const verseRef = `${currentSelection.book} ${currentSelection.chapter}:${currentSelection.verse}`;
              
              let prompt = "";
              if (type === 'explain') {
                  prompt = `You are a gentle, wise Bible assistant. First, quote the verse ${verseRef} (NIV or ESV) clearly. Then, provide a brief, uplifting 2-3 sentence theological explanation of its context and meaning. Use bolding for the verse text.`;
              } else if (type === 'prayer') {
                  prompt = `You are a prayer assistant. Write a short, heartfelt, first-person prayer (approx 2-3 sentences) inspired specifically by the themes in ${verseRef}. Do not quote the verse, just write the prayer.`;
              }

              try {
                  const text = await callGemini(prompt, apiKey);
                  setAiContent({ type, text });
              } catch (err) {
                  setAiError(err.message || "Connection interrupted. Please try again.");
                  setAiContent(null);
                  if (err.message.includes("Missing API Key") || err.message.includes("Invalid API Key")) {
                      setTimeout(() => openSettings(), 1500); // Auto-open settings on key error
                  }
              } finally {
                  setAiLoading(false);
              }
          };

          return (
            <div className="min-h-screen bg-slate-50 text-slate-800 flex flex-col overflow-x-hidden relative selection:bg-amber-100">
              
              {/* Background */}
              <div className="absolute top-0 left-0 w-full h-64 bg-gradient-to-b from-amber-50 to-transparent opacity-60 pointer-events-none" />
              <div className="absolute -top-24 -right-24 w-64 h-64 bg-amber-100 rounded-full blur-3xl opacity-40 pointer-events-none" />
              <div className="absolute bottom-0 left-0 w-full h-32 bg-gradient-to-t from-slate-100 to-transparent pointer-events-none" />

              {/* Header */}
              <header className="relative z-10 px-6 py-6 flex justify-between items-center">
                <div className="flex items-center gap-2 text-amber-900/80">
                  <IconBook className="w-6 h-6" />
                  <h1 className="text-lg font-semibold tracking-tight">Scripture Pick</h1>
                </div>
                <div className="flex gap-2">
                    <button 
                      onClick={openSettings}
                      className="p-2 rounded-full hover:bg-slate-200/50 transition-colors text-slate-500"
                    >
                      <IconSettings className="w-5 h-5" />
                    </button>
                    <button 
                      onClick={() => setShowHistory(!showHistory)}
                      className="p-2 rounded-full hover:bg-slate-200/50 transition-colors text-slate-500"
                    >
                      {showHistory ? <IconX className="w-5 h-5" /> : <IconRefreshCw className="w-5 h-5" />}
                    </button>
                </div>
              </header>

              {/* Main */}
              <main className="flex-1 relative z-10 flex flex-col items-center justify-start px-6 pb-32 pt-4 overflow-y-auto">
                
                <div className={`transition-all duration-700 ease-out transform w-full max-w-sm ${currentSelection ? 'translate-y-0 opacity-100' : 'translate-y-4 opacity-0'}`}>
                  {currentSelection ? (
                    <div className="flex flex-col items-center text-center space-y-6">
                      
                      {/* Result */}
                      <div className="relative group cursor-pointer w-full" onClick={generateVerse}>
                        <div className={`absolute inset-0 bg-amber-400/20 blur-xl rounded-full transition-opacity duration-500 ${isAnimating ? 'opacity-100 scale-110' : 'opacity-0'}`} />
                        
                        <div className="relative bg-white/80 backdrop-blur-md border border-white/50 shadow-[0_8px_32px_rgba(0,0,0,0.08)] rounded-3xl p-8 w-full mx-auto flex flex-col items-center gap-2 transition-transform duration-300 hover:scale-[1.02] active:scale-[0.98]">
                          
                          <div className="text-lg uppercase tracking-widest text-slate-400 font-medium mb-1">
                            Book
                          </div>
                          <div className="text-4xl sm:text-5xl font-serif text-slate-800 mb-6 transition-all duration-100 min-h-[3.5rem] leading-tight">
                            {currentSelection.book}
                          </div>

                          <div className="w-16 h-px bg-gradient-to-r from-transparent via-amber-300 to-transparent mb-6" />

                          <div className="flex items-center justify-center gap-8 sm:gap-12 w-full">
                            <div className="flex flex-col items-center">
                              <span className="text-xs uppercase tracking-wider text-slate-400 mb-2">Chapter</span>
                              <span className={`text-5xl sm:text-6xl font-light text-amber-600 tabular-nums leading-none ${isAnimating ? 'blur-[1px]' : ''}`}>
                                {currentSelection.chapter}
                              </span>
                            </div>
                            <div className="h-16 w-px bg-slate-100" />
                            <div className="flex flex-col items-center">
                              <span className="text-xs uppercase tracking-wider text-slate-400 mb-2">Verse</span>
                              <span className={`text-5xl sm:text-6xl font-light text-slate-800 tabular-nums leading-none ${isAnimating ? 'blur-[1px]' : ''}`}>
                                {currentSelection.verse}
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* Instructions */}
                      <p className={`text-slate-400 text-sm max-w-xs mx-auto transition-opacity duration-500 ${isAnimating ? 'opacity-0' : 'opacity-100'}`}>
                        Open your Bible to read the passage.
                      </p>

                      {/* AI Buttons Row */}
                      {!isAnimating && (
                         <div className="w-full flex gap-3 justify-center pt-2 animate-[fadeIn_0.5s_ease-out]">
                            <button 
                                onClick={() => handleAiAction('explain')}
                                className="flex-1 bg-white border border-slate-200 shadow-sm rounded-xl py-3 px-4 flex flex-col items-center gap-2 hover:bg-amber-50 hover:border-amber-200 transition-colors group"
                            >
                                <IconMessage className="w-6 h-6 text-indigo-400 group-hover:text-indigo-600" />
                                <span className="text-xs font-medium text-slate-600">✨ Explain</span>
                            </button>
                            <button 
                                onClick={() => handleAiAction('prayer')}
                                className="flex-1 bg-white border border-slate-200 shadow-sm rounded-xl py-3 px-4 flex flex-col items-center gap-2 hover:bg-emerald-50 hover:border-emerald-200 transition-colors group"
                            >
                                <IconHeartHandshake className="w-6 h-6 text-emerald-400 group-hover:text-emerald-600" />
                                <span className="text-xs font-medium text-slate-600">✨ Prayer</span>
                            </button>
                         </div>
                      )}

                      {/* AI Result Card */}
                      {(aiLoading || aiContent || aiError) && (
                          <div ref={aiSectionRef} className="w-full bg-white/60 backdrop-blur-sm border border-slate-100 rounded-2xl p-6 shadow-sm text-left animate-[slideUp_0.4s_ease-out]">
                             {aiLoading ? (
                                 <div className="flex items-center justify-center gap-3 py-4 text-slate-500">
                                     <IconSparkles className="w-5 h-5 animate-pulse text-amber-400" />
                                     <span className="text-sm font-medium">Consulting Gemini...</span>
                                 </div>
                             ) : aiError ? (
                                 <div className="flex flex-col items-center gap-2 text-center py-2">
                                     <div className="text-red-500 text-sm">{aiError}</div>
                                     <button onClick={openSettings} className="text-xs text-slate-500 underline">Update API Key</button>
                                 </div>
                             ) : (
                                 <div className="prose prose-slate prose-sm max-w-none">
                                     <div className="flex items-center gap-2 mb-3 pb-2 border-b border-slate-100">
                                         {aiContent.type === 'explain' ? (
                                             <><IconMessage className="w-4 h-4 text-indigo-500" /><span className="text-xs font-bold text-indigo-500 uppercase tracking-wider">Insight & Context</span></>
                                         ) : (
                                             <><IconHeartHandshake className="w-4 h-4 text-emerald-500" /><span className="text-xs font-bold text-emerald-500 uppercase tracking-wider">Prayer</span></>
                                         )}
                                     </div>
                                     <div dangerouslySetInnerHTML={{ __html: marked.parse(aiContent.text) }} />
                                 </div>
                             )}
                          </div>
                      )}

                    </div>
                  ) : (
                    // Empty State
                    <div className="text-center space-y-6 mt-20">
                      <div className="w-24 h-24 bg-white rounded-3xl shadow-xl flex items-center justify-center mx-auto rotate-3 mb-8">
                        <IconBook className="w-10 h-10 text-amber-500/80" />
                      </div>
                      <h2 className="text-2xl font-serif text-slate-700">Ready to read?</h2>
                      <p className="text-slate-400">Tap below to receive a scripture.</p>
                    </div>
                  )}
                </div>

              </main>

              {/* Main Button */}
              <div className="fixed bottom-8 left-0 right-0 z-20 flex justify-center px-6">
                <button
                  onClick={generateVerse}
                  disabled={isAnimating}
                  className={`
                    group relative w-full max-w-xs bg-slate-900 text-white h-16 rounded-2xl 
                    flex items-center justify-center gap-3 shadow-2xl shadow-slate-900/20 
                    transition-all duration-300 
                    ${isAnimating ? 'scale-95 bg-slate-800 cursor-wait' : 'hover:-translate-y-1 hover:shadow-xl active:scale-95'}
                  `}
                >
                  {isAnimating ? (
                    <IconRefreshCw className="w-5 h-5 animate-spin text-amber-400" />
                  ) : (
                    <>
                      <IconSparkles className="w-5 h-5 text-amber-300 group-hover:animate-pulse" />
                      <span className="font-medium text-lg">
                        {currentSelection ? 'Pick Another' : 'Find a Verse'}
                      </span>
                    </>
                  )}
                </button>
              </div>

              {/* Settings Modal */}
              {showSettings && (
                  <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                      <div className="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onClick={() => setShowSettings(false)}></div>
                      <div className="relative bg-white rounded-3xl shadow-2xl w-full max-w-sm overflow-hidden animate-[zoomIn_0.2s_ease-out]">
                          <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                              <h3 className="font-semibold text-slate-800">Settings</h3>
                              <button onClick={() => setShowSettings(false)} className="p-2 hover:bg-slate-200 rounded-full transition-colors">
                                  <IconX className="w-5 h-5 text-slate-500" />
                              </button>
                          </div>
                          <div className="p-6 space-y-4">
                              <div>
                                  <label className="block text-sm font-medium text-slate-700 mb-2">Gemini API Key</label>
                                  <input 
                                      type="password" 
                                      value={tempApiKey}
                                      onChange={(e) => setTempApiKey(e.target.value)}
                                      placeholder="Paste your API key here"
                                      className="w-full p-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-amber-500/50 bg-slate-50 text-sm"
                                  />
                                  <p className="text-xs text-slate-400 mt-2">
                                      Get a free key at <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-amber-600 hover:underline">Google AI Studio</a>.
                                      Your key is stored locally on this device.
                                  </p>
                              </div>
                              <button 
                                  onClick={handleSaveKey}
                                  className="w-full bg-slate-900 text-white h-12 rounded-xl font-medium flex items-center justify-center gap-2 hover:bg-slate-800 active:scale-95 transition-all"
                              >
                                  <IconSave className="w-4 h-4" /> Save Settings
                              </button>
                          </div>
                      </div>
                  </div>
              )}

              {/* History */}
              <div 
                className={`fixed inset-0 z-30 transition-all duration-500 ${showHistory ? 'visible' : 'invisible'}`}
              >
                <div 
                  className={`absolute inset-0 bg-slate-900/20 backdrop-blur-sm transition-opacity duration-500 ${showHistory ? 'opacity-100' : 'opacity-0'}`}
                  onClick={() => setShowHistory(false)}
                />
                <div 
                  className={`absolute right-0 top-0 bottom-0 w-full max-w-xs bg-white shadow-2xl transition-transform duration-500 ease-out flex flex-col ${showHistory ? 'translate-x-0' : 'translate-x-full'}`}
                >
                  <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <h3 className="font-semibold text-slate-800">History</h3>
                    <button onClick={() => setShowHistory(false)} className="p-2 hover:bg-slate-200 rounded-full transition-colors">
                      <IconX className="w-5 h-5 text-slate-500" />
                    </button>
                  </div>
                  <div className="flex-1 overflow-y-auto p-4 space-y-3">
                    {history.length === 0 ? (
                      <div className="text-center text-slate-400 py-10 flex flex-col items-center gap-3">
                        <IconRefreshCw className="w-8 h-8 opacity-20" />
                        <p>No verses picked yet</p>
                      </div>
                    ) : (
                      history.map((item, idx) => (
                        <div key={idx} className="p-4 rounded-xl bg-slate-50 border border-slate-100 flex items-center justify-between">
                          <div>
                            <div className="font-serif text-slate-800 font-medium">{item.book}</div>
                            <div className="text-sm text-slate-500">Chapter {item.chapter} : Verse {item.verse}</div>
                          </div>
                          <div className="text-xs text-slate-300">
                            {item.timestamp.toLocaleTimeString([], { hour: '2-digit', minute:'2-digit' })}
                          </div>
                        </div>
                      ))
                    )}
                  </div>
                </div>
              </div>

            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BiblePicker />);
    </script>
</body>
</html>


